# Tuwunel Matrix Homeserver â€” Caddy Docker Proxy setup
# Docs: https://matrix-construct.github.io/tuwunel/deploying/docker.html
#
# SETUP:
#   1. cp .env.example .env  and fill in the values
#   2. docker network create caddy
#   3. docker compose up -d

services:
    caddy:
        # caddy-docker-proxy: configures Caddy from container labels
        # https://github.com/lucaslorentz/caddy-docker-proxy
        image: lucaslorentz/caddy-docker-proxy:ci-alpine
        restart: unless-stopped
        ports:
            - 80:80
            - 443:443
        environment:
            - CADDY_INGRESS_NETWORKS=caddy
        networks:
            - caddy
        # Allows Caddy to reach services on host networking (livekit)
        extra_hosts:
            - "host.docker.internal:host-gateway"
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - caddy_data:/data
        labels:
            # Serve .well-known endpoints for Matrix federation from the root domain.
            # This lets your Matrix IDs look like @user:example.com even though
            # the homeserver runs on matrix.example.com.
            caddy: ${SERVER_NAME}
            caddy.0_respond: >-
                /.well-known/matrix/server {"m.server":"${MATRIX_SUBDOMAIN}:443"}
            caddy.1_respond: >-
                /.well-known/matrix/client
                {"m.homeserver":{"base_url":"https://${MATRIX_SUBDOMAIN}"},"m.server":{"base_url":"https://${MATRIX_SUBDOMAIN}"},"org.matrix.msc3575.proxy":{"url":"https://${MATRIX_SUBDOMAIN}"},"org.matrix.msc4143.rtc_foci":[{"type":"livekit","livekit_service_url":"https://${RTC_SUBDOMAIN}"}]}

    homeserver:
        image: ghcr.io/matrix-construct/tuwunel:latest
        restart: unless-stopped
        volumes:
            - db:/var/lib/tuwunel
            # Uncomment to use a config file instead of env vars:
            #- ./tuwunel.toml:/etc/tuwunel.toml
        environment:
            # The Matrix server name that appears in user IDs (@user:SERVER_NAME)
            TUWUNEL_SERVER_NAME: ${SERVER_NAME}
            TUWUNEL_DATABASE_PATH: /var/lib/tuwunel
            TUWUNEL_PORT: 6167
            TUWUNEL_ADDRESS: 0.0.0.0
            TUWUNEL_MAX_REQUEST_SIZE: 20000000  # ~20 MB
            # Registration: token-gated
            TUWUNEL_ALLOW_REGISTRATION: 'true'
            TUWUNEL_REGISTRATION_TOKEN: ${REGISTRATION_TOKEN}
            # Federation
            TUWUNEL_ALLOW_FEDERATION: 'true'
            TUWUNEL_TRUSTED_SERVERS: '["matrix.org"]'
            # TURN (for 1:1 voice/video calls)
            TUWUNEL_TURN_URIS: '["turns:${SERVER_NAME}?transport=tcp","turn:${SERVER_NAME}?transport=udp","turn:${SERVER_NAME}?transport=tcp"]'
            TUWUNEL_TURN_SECRET: ${TURN_SECRET}
            # Logging (uncomment to adjust verbosity)
            #TUWUNEL_LOG: warn,state_res=warn
        networks:
            - caddy
        labels:
            caddy: ${MATRIX_SUBDOMAIN}
            caddy.reverse_proxy: "{{upstreams 6167}}"

    coturn:
        image: coturn/coturn:latest
        restart: unless-stopped
        network_mode: host
        volumes:
            - ./coturn.conf:/etc/coturn/turnserver.conf:ro

    matrix-rtc-jwt:
        # lk-jwt-service: issues LiveKit tokens for Element Call
        image: ghcr.io/element-hq/lk-jwt-service:latest
        restart: unless-stopped
        environment:
            - LIVEKIT_JWT_BIND=:8081
            - LIVEKIT_URL=wss://${RTC_SUBDOMAIN}
            - LIVEKIT_KEY=${LIVEKIT_KEY}
            - LIVEKIT_SECRET=${LIVEKIT_SECRET}
            - LIVEKIT_FULL_ACCESS_HOMESERVERS=${SERVER_NAME}
        networks:
            - caddy
        labels:
            caddy: ${RTC_SUBDOMAIN}
            caddy.@jwt.path: /sfu/get* /healthz*
            caddy.0_handle_@jwt.reverse_proxy: "{{upstreams 8081}}"
            caddy.1_handle.reverse_proxy: host.docker.internal:7880

    matrix-rtc-livekit:
        # LiveKit: WebRTC SFU for group calls (Element Call)
        image: livekit/livekit-server:latest
        restart: unless-stopped
        command: --config /etc/livekit.yaml
        network_mode: host
        volumes:
            - ./livekit.yaml:/etc/livekit.yaml:ro

volumes:
    db:
    caddy_data:

networks:
    caddy:
        external: true
